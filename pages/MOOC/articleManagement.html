<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="Xenon Boostrap Admin Panel"/>
    <meta name="author" content=""/>
	<script>
		//防止未登录直接输入网址访问该网页
	    var userId = localStorage.getItem('userId');
        var userToken = localStorage.getItem('userToken');
        var classification = localStorage.getItem('classification');
        var loginName = localStorage.getItem('loginName');
        if(!userId || !userToken || !classification || !loginName ){

            location.href="login.html";
       		}
	</script>
    <title>mooc后台管理</title>
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Arimo:400,700,400italic"/>
    <!--link rel="stylesheet" href="assets/css/fonts/linecons/css/linecons.css"/-->
    <!--link rel="stylesheet" href="assets/css/fonts/fontawesome/css/font-awesome.min.css"/-->
    <link rel="stylesheet" href="assets/css/bootstrap.css"/>
    <link rel="stylesheet" href="assets/css/xenon-core.css"/>
    <link rel="stylesheet" href="assets/css/xenon-forms.css"/>
    <link rel="stylesheet" href="assets/css/fonts/fontawesome/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="assets/css/xenon-components.css"/>
    <link rel="stylesheet" href="assets/css/xenon-skins.css"/>
    <link rel="stylesheet" href="assets/css/foundsDeclareList.css"/>
    <link rel="stylesheet" href="/scripts/htmleditor/themes/default/default.css"/>
    <link rel="stylesheet" href="assets/css/zTreeStyle.css"/>

    <script src="assets/js/jquery-1.11.1.min.js"></script>
    <script src="/scripts/StationJSLib.js"></script>
    <script src="/scripts/uploadfile.js"></script>
    <script src="/scripts/htmleditor/kindeditor.js"></script>
    <script src="/scripts/htmleditor/lang/zh_CN.js"></script>
    <script src="jquery/jquery.ztree.core.js"></script>
     <script type="text/javascript" src="js/jquery.cookie.js"></script>

    
</head>

<body class="page-body">
<script>
//栏目树的定义
	var myDataTable;
    function getUrlParam(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) {
            return unescape(r[2]);
        }
        return null;
    }

    //保持(被选中的)侧边栏高亮
    function keepActive(){
        $("#a_articleManagement").parent().addClass('active');
    }
    //日志记录
   function log() {
    loadFromWS("home/bottomscripts.template", "sid=" + loginName + "$^@^$session=" + getAllSessionItems() + "$^@^$path=" + window.location.pathname);
    }
///配置ztree,为了实现新建和编辑文章时选择类型（栏目）下拉列表树
		var setting = {
			view: {
				dblClickExpand: false,
				selectedMulti:false
			},
			data: {
				simpleData: {
					enable: true
				}
			},
			callback: {
				beforeClick: beforeClick,
				onClick: clickNode
			}
		};
//用来存储下拉列表树(json)
		var type_zNodes;
//点击下拉列表树之前
		function beforeClick(treeId, treeNode) {
			var check = (treeNode && !treeNode.isParent);
			if (!check){
				alert("不能选择该项");
			}
			return check;
		}
//点击下拉列表树时执行的方法	
		function clickNode(e, treeId, treeNode) {
			var zTree = $.fn.zTree.getZTreeObj("typeTree"),
			nodes = zTree.getSelectedNodes(),
			v = "";
			typeId = "";
			nodes.sort(function compare(a,b){return a.id-b.id;});
			for (var i=0, l=nodes.length; i<l; i++) {
				v += nodes[i].name + ",";
				typeId += nodes[i].id + ",";
			}
			if (v.length > 0 ) v = v.substring(0, v.length-1);
			if (typeId.length > 0 ) typeId = typeId.substring(0, typeId.length-1);
			var typeObj = $("#typeSel");
			typeObj.val(v);
            $("#modal-article #type").val(typeId);
            $("#type2").val(typeId);
			$("#type2Sel").val(v);
            $("#type3").val(typeId);
			$("#type3Sel").val(v);
			hideMenu();
			ifTrabelInfoByColumnId(typeId);
		}
///显示下拉列表树  
//参数flag用来区分是哪个下拉列表，有三个取值：编辑文章，批量复制，批量移动
		function showMenu(flag) {
			var typeObj;		
			var typeOffset;
			if(flag == "文章编辑"){
				typeObj = $("#typeSel");			
				typeOffset = $("#typeSel").offset();
			}
			if(flag == "批量复制"){	
				typeObj = $("#type3Sel");						
				typeOffset = $("#type3Sel").offset();
			}
			if(flag == "批量移动"){
				typeObj = $("#type2Sel");			
				typeOffset = $("#type2Sel").offset();
			}	
			$("#menuContent").css({left:typeOffset.left + "px", top:typeOffset.top + typeObj.outerHeight() + "px"}).slideDown("fast");
			$("body").bind("mousedown", onBodyDown);
		}
///隐藏下拉列表树
		function hideMenu() {
			$("#menuContent").fadeOut("fast");
			$("body").unbind("mousedown", onBodyDown);
		}
///点击列表区域外后，隐藏下拉列表树
		function onBodyDown(event) {
			if (!(event.target.id == "menuBtn" || event.target.id == "menuContent" || $(event.target).parents("#menuContent").length>0)) {
				hideMenu();
			}
		}
    jQuery(document).ready(function ($) {

		var html = new Array();
		var htmlResult = function(){
			$("#main-menu").append(html[0]);
            keepActive();
            log();
		}
	    getFromWS("mainmooc/getNav.template","classification="+classification, html, htmlResult);

    	$(".user-info-menu #loginName").html(loginName);

		// Replace checkboxes when they appear
		var $state = $("#example-2 thead input[type='checkbox']");
		$("#example-2").on('draw.dt', function()
		{
			cbr_replace();
			$state.trigger('change');
		});
		// Script to select all checkboxes
		$state.on('change', function(ev)
		{
			var $chcks = $("#example-2 tbody input[type='checkbox']");
			if($state.is(':checked'))
			{
				$chcks.prop('checked', true).trigger('change');
			}
			else
			{
				$chcks.prop('checked', false).trigger('change');
			}
		});

		var columnsArray = new Array();
		var processResult_columnsArray = function(){
			type_zNodes = jQuery.parseJSON(columnsArray[0]) ;
			jQuery.fn.zTree.init(jQuery("#typeTree"), setting, type_zNodes);

		}
		getFromWS("mainmooc/getColumns.template", "operation=getGrantColumns$^@^$classification="+classification, columnsArray, processResult_columnsArray);

		var obj_tree = new Array();
		var processResult_tree = function () {
			var jd = obj_tree[0].replace(/\'/g, '\"');
			var jsonData = jd.replace(/&/g, '\'');
			jsonData = jsonData.substr(0, jsonData.length - 1);//去掉最后一个逗号
			var str = '[' + jsonData + ']';
			var zNodes = JSON.parse(str);//[{},{},....,{}]

			//alert(str); 
			var newTree = new Array();

			var firstTree = new Array();
			//var secondTree = new Array();
			for (var i = 0; i < zNodes.length; i++) {
				var json = {};
				json['text'] = zNodes[i].text;
				json['id'] = zNodes[i].id;
				json['nodes'] = new Array;
				newTree.push(json);
				//alert(json['text'] +  json['id']+ json['nodes']);
			}	//将所有的{}放入newTree中


			for(var i = 0; i < zNodes.length; i++){
				if (zNodes[i].pId == 0) {//如果是一级的栏目 -----
				//alert("一级栏目："+zNodes[i].id);        
				firstTree.push(newTree[i]);
				}
			}
			for(var j=0;j<firstTree.length;j++){
				for(var i = 0; i < zNodes.length; i++){
				   if (zNodes[i].pId == firstTree[j].id) {//如果是二级的栏目 -----
					 firstTree[j].nodes.push(newTree[i]);
				    }
				}
			}			 
			for(var k=0;k<firstTree.length;k++){
				for(var j=0;j<firstTree[k].nodes.length;j++){//如果是三级的栏目 -----
				for(var i = 0; i < zNodes.length; i++){
				   if (zNodes[i].pId == firstTree[k].nodes[j].id) {
					 firstTree[k].nodes[j].nodes.push(newTree[i]);
				    }
				}
				}
			}

			var allcolumnData = JSON.stringify(firstTree);
			var alength=0;
			alength = allcolumnData.length;
			$('#treeview-selectable').treeview({
				data: allcolumnData,
				backColor: '#fff',
				borderColor: '#eeeeee',
				nodeIcon: 'glyphicon glyphicon-indent-left',
				selectedBackColor: '#efebeb',
				selectedColor: '#8f1fdc',
				showIcon: true,
				showTags: false,
				levels:1,
                onNodeSelected: function (event, node) {   
                    //alert('你点击了' + node.text + 'id为' + node.id);
				    var obj = new Array();
				    var processResult = function () {

            			$("#modal-article #type").val(node.id);
						for(var i = 0; i < zNodes.length; i++){
							if(type_zNodes[i].id==node.id){
				    		$("#typeSel").val(type_zNodes[i].name);
					
							}
						}			
						myDataTable.fnClearTable();
						myDataTable.fnDestroy();
						$("#articlePanel").html(obj[0]);
						myDataTable = $("#example-2").dataTable({
//								"order": [2,"desc"]
						});

				    	}
				  getFromWS("mainmooc/getArticleList.template", "operation=getSomeArticle$^@^$typeId=" + node.id + "$^@^$classification="+classification + "$^@^$loginName="+loginName, obj, processResult);

                        	},

			});
		}

	getFromWS("mainmooc/getColumns.template",  "operation=getAllColumnsReadOnly$^@^$classification="+classification +"$^@^$loginName="+loginName, obj_tree, processResult_tree);


    var obj = new Array();
    var processResult = function () {
        $("#articlePanel").html(obj[0]);
        myDataTable = $("#example-2").dataTable({
//			"order": [3,"desc"]
		});

        var deleteModal = $("#deleteModal");
        deleteModal.on("show.bs.modal", function (e) {
            // 这里的btn就是触发元素，即你点击的删除按钮
            var btn = $(e.relatedTarget);
            var id = btn.data("id");
        	var type = $("#modal-article #type").val();
            $("#removeItem").on('click',
		    function () {
				deleteArticle(id,type);
		       });
        	});

    }
  getFromWS("mainmooc/getArticleList.template", "operation=getAllArticle$^@^$classification=" + classification + "$^@^$loginName="+loginName, obj, processResult);


    });
    var editor;
    function createEditor() {


        editor = KindEditor.create('textarea[id="articleContent"]', {
            allowFileManager: true,
            uploadJson: kindeditUploadUrl(),
            afterUpload: kindeditAfterUpload,
            imageTabIndex: 1,
            pasteType: 1,  //无格式粘贴
        });
    }
	//重新加载文章，并且定位到当前选中的栏目
	function reloadArticle(type){
	    var obj = new Array();
	    var processResult = function () {
            $("#modal-article #type").val(type);
			for(var i = 0; i < type_zNodes.length; i++){
				if(type_zNodes[i].id==type){
	    			$("#typeSel").val(type_zNodes[i].name);
		
				}
			}						
			myDataTable.fnClearTable();
			myDataTable.fnDestroy();
			$("#articlePanel").html(obj[0]);
	    	}
	  getFromWS("mainmooc/getArticleList.template", "operation=getSomeArticle$^@^$typeId=" + type + "$^@^$classification="+classification + "$^@^$loginName="+loginName, obj, processResult);
	}
    function deleteArticle(id,type){
            var result = new Array();
            var deleteResult = function () {
                if (result[0] == "ok") {
                    $('#deleteModal').modal('hide');
					$('#batchDeleteModal').modal('hide');
					//重新加载文章，并且定位到当前选中的栏目
					if(type==""){
						location.reload();
					}else{
						reloadArticle(type);
					}

                } else {
                    alert("删除失败");
                			}
            			}
            var paras = "id=" + id;
            paras += "$^@^$operation=deleteArticle";

            getFromWS("mainmooc/saveArticle.template", paras, result, deleteResult);
	}

    //获取文件名称
    function getFileName(path) {
        var pos1 = path.lastIndexOf('/');
        var pos2 = path.lastIndexOf('\\');
        var pos = Math.max(pos1, pos2);
        if (pos < 0) {
            return path;
        }
        else {
            return path.substring(pos + 1);
        }
    }
    function updatePicName() {
        $("#picName").val(getFileName($("#picInput").val()));
        $("#modal-article #picImg").css("display","inline-block");
//		$("#picImg").attr("src",$("#picInput").val());
	    var fr = new FileReader();
	    fr.onload = function() {
			document.getElementById('picImg').src = fr.result;
	    	};
	    fr.readAsDataURL($("#picInput")[0].files[0]);
    }
    function updateAppendixName() {
        $("#appendixName").val(getFileName($("#appendixInput").val()));
    }

    //登陆edx Studio
    function createCourse() {
        email = localStorage.getItem("loginName");
        passwd = localStorage.getItem("passWord");
        if(!email || !passwd){
            alert("服务器繁忙,请稍后继续")
            return
        }
        createUrl = "//192.168.10.138/mylogin";
        createUrl += "?email=";
        createUrl += email;
        createUrl += "&password=";
        createUrl += passwd;
        // ?email=staff@example.com&password=edx&redirect_url=dashboard
        createUrl += "&redirect_url=//192.168.10.138:18010";
        location.href = createUrl;
    }

    function setArticle(flag) {
        $("#bufferArticleId").val(flag);
        if (editor) {
            editor.remove("#articleContent");
        	}
        $("#modal-article #appendix-group").html("");
        //新建文章
        if (flag == 0) {
            $("#modal-article #publisher").val(localStorage.getItem("loginName"));
            $("#modal-article #articleId").val(flag);
            $("#modal-article #title").val("");
            $("#modal-article #topArticle").val("0");
            $("#modal-article #school").val();
            $("#modal-article #bufferPicIds").val("");
            $("#modal-article #articleContent").val("");
            $("#modal-article #picInput").val("");
            $("#modal-article #appendixInput").val("");
            $("#modal-article #picId").val("0");
            $("#modal-article #picImg").attr("src","");
			$("#modal-article #picImg").css("display","none");
            $("#modal-article #appendixId").val("");
            $("#modal-article #picName").val("");
            $("#modal-article #appendixName").val("");

            $("#modal-article #picInput").removeAttr("disabled");
			$("#travelInfo #theme").val("");
			$("#travelInfo #district").val("");
			$("#travelInfo #money").val("");
			$("#travelInfo #address").val("");

            createEditor();
            jQuery('#modal-article').modal('show', {backdrop: 'static'});

        } else {  //编辑文章

		//如果是旅游推荐模块则查询旅游推荐相关信息	
			var paras = "id=" + flag;
			paras += "$^@^$columnId="+$("#type" + flag).val();
			paras += "$^@^$operation=queryTravelInfo";
			var obj = new Array();
			var processResult = function(){
				if(obj[0] !="no"){
					var travelArray = obj[0].split(";");
					$("#travelInfo #theme").val(travelArray[0]);
					$("#travelInfo #district").val(travelArray[1]);
					$("#travelInfo #money").val(travelArray[2]);
					$("#travelInfo #address").val(travelArray[3]);
					$("#travelInfo").css("display","block");
					$("#bufferIfTravelInfo").val("yes");
				}else{
					$("#travelInfo").css("display","none");
					$("#bufferIfTravelInfo").val("no");
				}
			}
			getFromWS("mainmooc/travelInfo.template",paras,obj,processResult);
						

            $("#modal-article #articleId").val(flag);
            $("#modal-article #title").val($("#title" + flag).html());
            $("#modal-article #publisher").val($("#publisher" + flag).html());
            $("#modal-article #type").val($("#type" + flag).val());
			for(var i = 0; i < type_zNodes.length; i++){
				if(type_zNodes[i].id==$("#type" + flag).val()){
            		$("#modal-article #typeSel").val(type_zNodes[i].name);
					
				}
			}
           //
            //
            //
            // alert(flag);
            $("#modal-article #topArticle").val($("#top" + flag).val());
            $("#modal-article #school").val($("#school" + flag).val());
            $("#modal-article #articleContent").val($("#content" + flag).val());
            //副文本中的图片
            $("#modal-article #bufferPicIds").val("");
            $("#modal-article #picName").val("");
            $("#modal-article #appendixName").val("");
            var picId = $("#picId" + flag).val();
            var appendixId = $("#appendixId" + flag).val();

            //该文章对应的图片
            $("#modal-article #picId").val(picId);

            $("#modal-article #appendixId").val(appendixId);

            if (picId != 0) {
                $("#modal-article #picInput").attr("disabled", "disabled");
				$("#modal-article #picImg").css("display","inline-block");
		    	$("#modal-article #picImg").attr("src","/one/downloadFile.spe?dtype=PostgresXL&mode=html&fileid="+picId);
            } else {
                $("#modal-article #picInput").removeAttr("disabled");
				$("#modal-article #picImg").css("display","none");
            	$("#modal-article #picImg").attr("src","");
            		}
			///如果有图片或者附件，则从数据库中查出相关文件的name
            if (picId != 0 || appendixId != "") {
                var result = new Array();
                var queryResult = function () {
                    if (result[0]) {

                        var names = result[0].split("|");
                        var picName = names[0];
                        $("#modal-article #picName").val(picName);
						

						var parentDiv = document.getElementById("appendix-group"); 
						var articleId = $("#modal-article #articleId").val();
						if(appendixId !=""){
							var appendixIds = appendixId.split(";");
		                	var appendixNames = names[1].split(";");
							for(var i=0;i<appendixNames.length;i++){
								//动态创建div用来显示上传的附件名，以及删除和下载的标签

								var insertDiv = '<div id="appendixId' + appendixIds[i] + '"><span style="display:inline-block;width:200px;overflow: hidden;text-overflow: ellipsis;" id="appendixName'+appendixIds[i]+'">'+appendixNames[i]+'</span><a style="margin-left:30px;color:blue" href="javaScript:deleteAppendix(\''+appendixIds[i]+'\',\''+articleId+'\')">删除</a><a style="margin-left:50px;color:blue" href="/one/downloadFile.spe?dtype=PostgresXL&mode=attachment&fileid='+appendixIds[i]+'">下载</a></div>';
								parentDiv.innerHTML = parentDiv.innerHTML + insertDiv;
							}
						}
                        createEditor();
                        jQuery('#modal-article').modal('show', {backdrop: 'static'});
                   	 		}
                		}
                var paras = "picId=" + picId;
                paras += "$^@^$appendixId=" + appendixId;
                paras += "$^@^$operation=getPicAndAppendixName";

                getFromWS("mainmooc/saveArticle.template", paras, result, queryResult);
            } else {
                createEditor();
                jQuery('#modal-article').modal('show', {backdrop: 'static'});
            }
        }
    }
    function deletePic() {
        $("#picInput").val("");
        $("#picName").val("");
		$("#modal-article #picImg").attr("src","");
		$("#modal-article #picImg").css("display","none");
        var picId = $("#modal-article #picId").val();
        if (picId != 0) {
            var result = new Array();
            var deleteResult = function () {
                if (result[0] == "ok") {
                    $("#modal-article #picId").val("0");
                    $("#modal-article #picName").val("");
                    $("#modal-article #picInput").val("");
                    $("#picId" + $("#bufferArticleId").val()).val("0");
                    $("#modal-article #picInput").removeAttr("disabled");
                } else {
                    alert("删除失败");
                }
            }
            var paras = "id=" + picId;
            paras += "$^@^$operation=deletePic";
            getFromWS("mainmooc/saveArticle.template", paras, result, deleteResult);
        }
    }
    function deleteAppendix(id,aid) {

		if (id != "") {
		    var result = new Array();
		    var deleteResult = function () {

				var father = document.getElementById("appendix-group"); 
				var child = document.getElementById("appendixId"+id); 
				father.removeChild(child); 
				//删除一个附件后更新附件域
				$("#modal-article #appendixId").val(result[0]);

		    	}
		    var paras = "id=" + id;
		    paras += "$^@^$articleId="+aid;
		    paras += "$^@^$operation=deleteAppendix";

		    getFromWS("mainmooc/saveArticle.template", paras, result, deleteResult);
		}else{
			alert("wrong");
		}


    }
//上传附件
function uploadAppendix(){
	var articleId = $("#modal-article #articleId").val();
	if(!($("#modal-article #appendixInput").val())){
		alert("请先选择文件");
		return;
	}
    var setAppendixId = function (fileId) {
        if (fileId) {
			
            var appendixId = $("#modal-article #appendixId").val();
			if(appendixId ==""){
				$("#modal-article #appendixId").val(fileId)
			}else{
				$("#modal-article #appendixId").val(appendixId+";"+fileId)
			}
			var fileName = getFileName($("#appendixInput").val());

			//动态创建div用来显示上传的附件名，以及删除和下载的标签
			var insertDiv = '<div id="appendixId' + fileId + '"><span style="display:inline-block;width:200px;overflow: hidden;text-overflow: ellipsis;" id="appendixName'+fileId+'">'+fileName+'</span><a style="margin-left:30px;color:blue" href="javaScript:deleteAppendix(\''+fileId+'\',\''+articleId+'\')">删除</a><a style="margin-left:30px;color:blue" href="/one/downloadFile.spe?dtype=PostgresXL&mode=attachment&fileid='+fileId+'">下载</a></div>';
			var parentDiv = document.getElementById("appendix-group"); 
			parentDiv.innerHTML = parentDiv.innerHTML + insertDiv;

			var result = new Array()
			var processResult = function(){

                // alert(result[0]);
				$("#modal-article #appendixName").val("")
			}
		    var paras = "appendixId=" + $("#modal-article #appendixId").val();
		    paras += "$^@^$articleId="+articleId;
		    paras += "$^@^$operation=updateAppendixId";
			if(articleId !=0 && articleId !=""){
		    	getFromWS("mainmooc/saveArticle.template", paras, result, processResult);
			}
        	}	
    	}
    uploadToDatabase("modal-article #appendixInput", setAppendixId, "databaseType=PostgresXL");
}

    function doSave() {
        var title = $("#modal-article #title").val();
        var school = $("#modal-article #school").val();
        //alert(school);
        if(school!= ""){
            //查询数据库是否有相应学校
            var schoolcontent = new Array();
            var contentResult = function(){
                /* jQuery("#SchoolCourse").html(content[0]);*/

                if(schoolcontent[0] !="no"){
                    var schoollist = schoolcontent[0].split(";");
                    $("#modal-article #school").val(schoollist[2]);
                    //alert(schoollist[2]);
                }esle
                {
                    $("#modal-article #school").val();
                }
            }
            getFromWS("homemooc/getSchoolName.template","school="+school,schoolcontent,contentResult);
        }
        var type = $("#modal-article #type").val();
        var content = editor.html();
        var picId = $("#modal-article #picId").val();
        var appendixId = $("#modal-article #appendixId").val();
	
		var theme = $("#travelInfo #theme").val();
		var district = $("#travelInfo #district").val();
		var money = $("#travelInfo #money").val();
		var address = $("#travelInfo #address").val();

        if (!title ||!school || !type || !publisher || !content || (!$("#picInput").val()&&!picId)) {
            alert("请把标题，学校，类型，文章内容，文章图片补充完整");
            return;
        	}

//如果是旅游信息则需要填写 主题，地区，花费，详细地址的信息
		if($("#bufferIfTravelInfo").val()=="yes"&&(!theme || !district || !money || !address)){
			alert("请把主题，地区，花费，详细地址补充完整");
			return;
		}
        if ($("#picInput").val()) {
            //上传图片
            var setPicId = function (fileId_pic) {
                if (fileId_pic) {
                    picId = fileId_pic;
                    doSaveArticle(picId);
                    			
                		}	
            		}
            uploadToDatabase("picInput", setPicId, "databaseType=PostgresXL");
        } else {
            doSaveArticle(picId);            		
        	}
    }
    function doSaveArticle(picId) {

        var id = $("#modal-article #articleId").val();
        var title = $("#modal-article #title").val();
        var type = $("#modal-article #type").val();
        var top = $("#modal-article #topArticle").val();
        var school = $("#modal-article #school").val();
        var publisher = localStorage.getItem("loginName");
        var picIds = $("#bufferPicIds").val();
        var content = editor.html();
		var content_text = editor.text();
//和旅游推荐有关的
		var theme = $("#travelInfo #theme").val();
		var district = $("#travelInfo #district").val();
		var money = $("#travelInfo #money").val();
		var address = $("#travelInfo #address").val();
		var ifTravelInfo = $("#bufferIfTravelInfo").val();
		var appendixId = $("#appendixId").val();

        var operation;
        if (id == 0) {
            operation = "newArticle";
        } else {
            operation = "editArticle";
        	}
        var paras = "id=" + id;
        paras += "$^@^$title=" + title;
        paras += "$^@^$type=" + type;
        paras += "$^@^$top=" + top;
        paras += "$^@^$school=" + school;
        paras += "$^@^$publisher=" + publisher;
        paras += "$^@^$content=" + content;
		paras += "$^@^$content_text=" + content_text;
        paras += "$^@^$picIds=" + picIds;
        paras += "$^@^$picId=" + picId;
        paras += "$^@^$appendixId=" + appendixId;

		paras += "$^@^$theme=" + theme;
        paras += "$^@^$district=" + district;
        paras += "$^@^$money=" + money;
        paras += "$^@^$address=" + address;
        paras += "$^@^$ifTravelInfo=" + ifTravelInfo;

        paras += "$^@^$operation=" + operation;
        var objs = new Array();
        var afterSaveArticle = function () {
            if (objs[0] == "ok") {
        			$("#modal-article #bufferPicIds").val("");
					$("#modal-article").modal('hide');                
					reloadArticle(type);
            } else {
                alert("存储失败");
            		}
        	};
        getFromWS("mainmooc/saveArticle.template", paras, objs, afterSaveArticle);
    }

    //得到外部传来的数据]


    function closeDia() {
        var picIds = $("#modal-article #bufferPicIds").val();
        if (picIds != "") {
            var paras = "$^@^$picIds=" + picIds;
            paras += "$^@^$operation=deleteFiles";
            var objs = new Array();
            var afterDelete = function () {
                $("#modal-article").modal('hide');
        		var type = $("#modal-article #type").val();
				reloadArticle(type);

            		};
            getFromWS("mainmooc/saveArticle.template", paras, objs, afterDelete);
        } else {
            $("#modal-article").modal('hide');
			var type = $("#modal-article #type").val();
			reloadArticle(type);
        	}

    }

//批量删除弹出框
function batchDelete(){

		$('#bitchDeleteModal').modal();

}
//点击确定后，批量删除结果
function saveBatchDelete(){
		var checkboxs = document.getElementsByName("articleCheckBox");
		var ids = "";
		for (var i = 0; i < checkboxs.length; i++) {
		    if (checkboxs[i].checked){
				ids = ids + checkboxs[i].value + ";";

		    	}
		}
	    var result = new Array();
	    var deleteResult = function () {
			if (result[0] == "ok") {
				location.reload();
			} else {
			    alert("删除失败");
			}
	    	}
	    var paras = "ids=" + ids;
	    paras += "$^@^$operation=batchDelete";

	    getFromWS("mainmooc/saveArticle.template", paras, result, deleteResult);
}
//弹出批量移动选择框
function batchEdit(){
	$('#batchEditModal type2').val("");
	$('#batchCopyModal type3Sel').val("");
	$('#batchEditModal').modal();

}
//保存批量移动
function saveBatchEdit(){
		var articleType = $("#batchEditModal #type2").val();
		if(articleType == ""){
			alert("文章类型不能为空");
			return;
		}
		var submitAids = "";
		var checkboxs = document.getElementsByName("articleCheckBox");
		for (var i = 0; i < checkboxs.length; i++) {
		    if (checkboxs[i].checked){

				submitAids = submitAids + checkboxs[i].value + ",";
		    	}
		}
		var obj = new Array();
		var processResult = function(){
			$('#batchEditModal').modal("hide");
			location.reload();
		}
		var paras = "articleIds=" + submitAids;
	    paras += "$^@^$articleType="+articleType;
	    paras += "$^@^$operation=bitchEdit";
		getFromWS("mainmooc/saveArticle.template", paras, obj, processResult);
}
//弹出批量复制选择框
function batchCopy(){
	$('#batchCopyModal type3').val("");
	$('#batchCopyModal type3Sel').val("");
	$('#batchCopyModal').modal();
}
//保存批量复制
function saveBatchCopy(){
		var articleType = $("#batchCopyModal #type3").val();
		if(articleType == ""){
			alert("文章类型不能为空");
			return;
		}
		var submitAids = "";
		var checkboxs = document.getElementsByName("articleCheckBox");
		for (var i = 0; i < checkboxs.length; i++) {
		    if (checkboxs[i].checked){

				submitAids = submitAids + checkboxs[i].value + ",";
		    	}
		}
		var obj = new Array();
		var processResult = function(){
			$('#batchCopyModal').modal("hide");
			location.reload();
		}
		var paras = "articleIds=" + submitAids;
		paras += "$^@^$articleType="+articleType;
		paras += "$^@^$operation=bitchCopy";
		getFromWS("mainmooc/saveArticle.template", paras, obj, processResult);
}

function ifTrabelInfoByColumnId(id){
	var paras = "columnId=" + id;
	paras += "$^@^$operation=ifTravelInfoColumn";
	var obj = new Array();
	var processResult = function(){
		if(obj[0] == "yes"){
			$("#travelInfo").css("display","block");
			$("#bufferIfTravelInfo").val("yes");
		}else{
			$("#travelInfo").css("display","none");
			$("#bufferIfTravelInfo").val("no");
		}
	
	}
	getFromWS("mainmooc/travelInfo.template",paras,obj,processResult);
}
</script>
<div style="display:none">
    <input type="text" value="0" id="bufferArticleId">
    <input type="text" value="no" id="bufferIfTravelInfo">
</div>
<div class="page-container">
    <div class="sidebar-menu toggle-others fixed">
        <div class="sidebar-menu-inner">
            <header class="logo-env">
                <div class="logo">
                    <a href="articleManagement.html" class="logo-expanded">
                        <img src="assets/images/logo@2x.png" width="80" alt=""/></a>
                    <a href="articleManagement.html" class="logo-collapsed">
                        <img src="assets/images/logo-collapsed@2x.png" width="40" alt=""/></a>
                </div>
                <div class="mobile-menu-toggle visible-xs">
                    <a href="#" data-toggle="user-info-menu">
                        <i class="fa-bell-o"></i>
                        <span class="badge badge-success">7</span></a>
                    <a href="#" data-toggle="mobile-menu">
                        <i class="fa-bars"></i>
                    </a>
                </div>
            </header>
            <ul id="main-menu" class="main-menu">

            </ul>
        </div>
    </div>
    <div class="main-content">
        <!-- User Info, Notifications and Menu Bar -->
        <nav class="navbar user-info-navbar" role="navigation">
            <ul class="user-info-menu left-links list-inline list-unstyled">
                <li class="hidden-sm hidden-xs">
                    <a href="#" data-toggle="sidebar">
                        <i class="fa-bars"></i>
                    </a>
                </li>
            </ul>
            <ul class="user-info-menu left-links list-inline list-unstyled">
            <a href="#" data-toggle="sidebar" title="武汉大学出版社">
                <img src="images/logo.png" width="170" alt="武汉大学出版社" />
            </a>
        </ul>

            <ul class="user-info-menu right-links list-inline list-unstyled">
                <li class="dropdown user-profile">
                    <a href="#" data-toggle="dropdown">
                        <img src="assets/images/user-4.png" alt="user-image" class="img-circle img-inline userpic-32"
                             width="28"/>
                        <span id="loginName"></span></a>
                </li>
                <li>
                    <a href="#" onclick="logout()">
                        <i class="fa-power-off" style="color:red;font-size:18px;"></i>
                    </a>
                </li>
            </ul>

        </nav>
        <div class="page-title">
            <div class="title-env">
                <h1 class="title">课程管理</h1>
                <!--<p class="description">management of article</p>--></div>
            <div class="breadcrumb-env">
                <ol class="breadcrumb bc-1">
                    <li>
                        <a href="articleManagement.html">
                            <i class="fa-home">首页</i></a>
                    </li>
                    <li class="active">
                        <strong>课程管理</strong></li>
                </ol>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">课程管理</h3>
            </div>
            <div class="panel-body">
                <div class="row">
                    <div class="col-sm-3">
                      
                    	<h4 style="margin-bottom:20px;">
							<span style="color:#000">栏目列表</span>
						</h4>
                      
                        <div id="treeview-selectable" class="treeview">

                        </div>
                    </div>
                    <div class="col-sm-9">
                        <div class="panel-heading">
							<h4 style="margin-bottom:20px;">
								<span style="color:#000">课程列表</span>
								<button  id="batchDelete" class="btn btn-purple btn-icon btn-icon-standalone" style="margin-left:5px;float:right" onclick="batchDelete()">
										<i class="fa-trash" style="font-size:17px"></i>
										<span>批量删除</span>
								</button>
								<button  id="batchEdit" class="btn btn-purple btn-icon btn-icon-standalone" style="margin-left:5px;float:right" onclick="batchEdit()">
										<i class="fa-edit" style="font-size:17px"></i>
										<span>批量移动</span>
								</button>
								<button  id="batchCopy" class="btn btn-purple btn-icon btn-icon-standalone" style="margin-left:5px;float:right" onclick="batchCopy()">
										<i class="fa-copy" style="font-size:17px"></i>
										<span>批量复制</span>
								</button>
							    <button class="btn btn-secondary btn-icon btn-icon-standalone"
							       style="margin-left:5px;float:right"  onclick="createCourse()">
                                        <!--onclick="setArticle(0)"-->

									<i class="fa-plus" style="font-size:17px"></i>
									<span >新增课程</span>
							    </button>
							</h4>
                            <div class="panel-body">
                                <table class="table table-bordered table-striped" id="example-2">
                                    <thead>
                                    <tr>
										<th class="no-sorting">
											<input type="checkbox" class="cbr">
										</th>
                                        <th>标题</th>
                                        <th>发布者</th>
                                        <th>内容</th>
                                        <th>发布</th>
                                        <th>操作</th>
                                    </tr>
                                    </thead>
                                    <tbody id="articlePanel" class="middle-align">
                                    
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="graphs" id="mainContent">

            </div>

            <footer class="main-footer sticky footer-type-1">
                <div class="footer-inner">
                    <div class="footer-text">&copy; 2017
                        <strong>MOOC服务</strong>
                        <a href="#" target="_blank">MOOC管理系统</a>- Collect from
                        <a href="#" title="国家网络安全学院" target="_blank">国家网络安全学院</a></div>
                    <div class="go-up">
                        <a href="#" rel="go-top">
                            <i class="fa-angle-up"></i>
                        </a>
                    </div>
                </div>
            </footer>
        </div>
    </div>
</div>
<div class="modal fade" id="modal-article">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" onclick="closeDia()">&times;</button>
                <h4 class="modal-title">编辑课程</h4>
            </div>

            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">

                        <div class="form-group">
                            <label for="field-4" class="control-label">标题: </label>
                            <input type="text" class="form-control" id="title" placeholder="标题"
                                   style="display:inline-block;width:30%">
                            <input type="text" id="articleId" style="display:none">
                            <input type="text" id="bufferPicIds" value="" style="display:none">
							<li class="title" style="display:inline-block">&nbsp;&nbsp;类型：<input id="typeSel" type="text" readonly value="" style="width:120px;"/>
								<a id="menuBtn" style="color:blue" href="#" onclick="showMenu('文章编辑'); return false;">选择类型</a>
							</li>
							<input type="text" id="type" value="" style="display:none">
<!--
                            <label for="field-4" class="control-label">类型: </label>
                            <select class="form-control" id="type" style="display:inline-block;width:20%" onchange="ifTravelInfo()">
-->                          <label for="field-4" class="control-label">学校: </label>
                            <input type="text" class="form-control" id="school" placeholder="学校"
                                   style="display:inline-block;width:20%">
                          <!--  <select class="form-control" id="school" style="display:inline-block;width:20%">
                                <option value="武汉大学">武汉大学</option>
                                <option value="中原大学">中原大学</option>
                                <option value="长安大学">长安大学</option>
                                <option value="中国人民大学">中国人民大学</option>
                            </select>-->
                            <br/>
                            <br/>
                            <label for="field-4" class="control-label">发布者: </label>

                            <input class="form-control" id="publisher" readonly="readonly"
                                   style="display:inline-block;width:15%"><br/>

                            <label for="field-4" class="control-label">置顶: </label>
                            <select class="form-control" id="topArticle" style="display:inline-block;width:10%">
                                <option value="0">否</option>
								<option value="1">是</option>

                            </select>
                        </div>

                    </div>

                    <div class="col-md-12">

                        <div class="form-group">
                            <label for="field-4" class="control-label">图片: </label>
                            <input type="text" value="0" id="picId" style="display:none">
                            <input type="text" id="picName" class="form-control" style="display:none;width:30%" readonly>
							<img id="picImg" src="" style="width:150px;height:60px">
                            <input type="file" id="picInput" value="上传图片"
                                   style="display:inline-block;width:70px;color: transparent;"
                                   onchange="updatePicName()">
                            <input type="button" value="删除图片" onclick="deletePic()">

                        </div>

                    </div>
                    <div class="col-md-12">

                        <div class="form-group">
                            <label for="field-4" class="control-label">附件: </label>
                            <input type="text" value="" id="appendixId" style="display:none">
                            <input type="text" id="appendixName" class="form-control"
                                   style="display:inline-block;width:30%" readonly>
                            <input type="file" id="appendixInput" value="选择附件"
                                   style="display:inline-block;width:70px;color: transparent;"
                                   onchange="updateAppendixName()">
                            <input type="button" value="上传文件" onclick="uploadAppendix()">
<!--
                            <input type="button" value="删除文件" onclick="deleteAppendix()">
-->							
                        </div>
						<!--此div用来先显示已经上传的附件，可以删除和下载-->
                        <div class="form-group" id="appendix-group">

                        </div>
                    </div>
                    <div class="col-md-12" id="travelInfo" style="display:none">

                        <div class="form-group" >
                            <label  class="control-label">特点: </label>
                            <input type="text" placeholder="主题/口味等" id="theme" style="width:100px">
                            <label class="control-label">所在地区: </label>
                            <select id="district" style="width:80px">
								<option value="多宝镇">多宝镇</option>
								<option value="拖市镇">拖市镇</option>
								<option value="蒋湖">蒋湖</option>
								<option value="渔薪镇">渔薪镇</option>
								<option value="蒋场镇">蒋场镇</option>
								<option value="佛子山镇">佛子山镇</option>
								<option value="黄潭镇">黄潭镇</option>
								<option value="汪场镇">汪场镇</option>
								<option value="岳口镇">岳口镇</option>
								<option value="横林镇">横林镇</option>
								<option value="彭市镇">彭市镇</option>
								<option value="麻洋镇">麻洋镇</option>
								<option value="多祥镇">多祥镇</option>
								<option value="干驿镇">干驿镇</option>
								<option value="马湾镇">马湾镇</option>
								<option value="卢市镇">卢市镇</option>
								<option value="小板镇">小板镇</option>
								<option value="皂市镇">皂市镇</option>
								<option value="胡市镇">胡市镇</option>
								<option value="石河镇">石河镇</option>
								<option value="张港镇">张港镇</option>
								<option value="九真镇">九真镇</option>
								<option value="石家河镇">石家河镇</option>
								<option value="天门工业园">天门工业园</option>
								<option value="净潭乡">净潭乡</option>
							</select>
                            <label  class="control-label">费用: </label>
                            <input type="text" placeholder="元(整数)" id="money" style="width:60px">
                            <label  class="control-label">详细地址: </label>
                            <input type="text" placeholder="地址"  id="address" style="width:150px">
                        </div>
                    </div>
                    <div class="col-md-12">

                        <div class="form-group">
                            <label for="field-4" class="control-label">文章内容: </label>
                            <textarea class="form-control" id="articleContent" style="height:300px">

					            </textarea>

                        </div>

                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-white" onclick="closeDia()">关闭</button>
                <button type="button" class="btn btn-info" onclick="doSave()">保存</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header noborder">
                <h4 class="modal-title">确定删除此条申报记录？</h4>
            </div>
            <div class="modal-footer noborder">
                <button type="button" class="btn btn-white" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-info" style="margin-left:40px" id="removeItem">确定</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="deleteAppendixModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header noborder">
                <h4 class="modal-title">确定删除？</h4>
            </div>
            <div class="modal-footer noborder">
                <button type="button" class="btn btn-white" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-info" style="margin-left:40px" id="removeAppendix">确定</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="bitchDeleteModal">
    <div class="modal-dialog" style="width:400px;margin-top: 200px;">
        <div class="modal-content">
            <div class="modal-header noborder">
                <h4 class="modal-title">确定删除这些申报记录？</h4>
            </div>
            <div class="modal-footer noborder">
                <button type="button" class="btn btn-white" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-info" style="margin-left:40px" onclick="saveBatchDelete()">确定</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="batchEditModal">
    <div class="modal-dialog" style="width:600px">
        <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title">批量移动</h4>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="field-5" class="control-label">移动到栏目: </label>
								<li class="title" style="display:inline-block">&nbsp;&nbsp;
									类型：<input id="type2Sel" type="text" readonly value="" style="width:120px;"/>
									&nbsp;<a id="menuBtn" style="color:blue" href="#" onclick="showMenu('批量移动'); return false;">选择</a>
								</li>

                                    <input id="type2" style="display:none">
                            </div>
                        </div>
                    </div>
                </div>
            <div class="modal-footer noborder">
                <button type="button" class="btn btn-white" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-info" style="margin-left:40px" onclick="saveBatchEdit()">确定</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="batchCopyModal">
    <div class="modal-dialog" style="width:600px">
        <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title">批量复制</h4>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="field-5" class="control-label">复制到栏目: </label>
								<li class="title" style="display:inline-block">&nbsp;&nbsp;
									类型：<input id="type3Sel" type="text" readonly value="" style="width:120px;"/>
									&nbsp;<a id="menuBtn" style="color:blue" href="#" onclick="showMenu('批量复制'); return false;">选择</a>
								</li>

                                    <input id="type3" style="display:none">
                            </div>
                        </div>
                    </div>
                </div>
            <div class="modal-footer noborder">
                <button type="button" class="btn btn-white" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-info" style="margin-left:40px" onclick="saveBatchCopy()">确定</button>
            </div>
        </div>
    </div>
</div>
<div id="menuContent" class="menuContent" style="display:none; position: absolute;z-index: 1050;background-color:white">
	<ul id="typeTree" class="ztree" style="margin-top:0; width:160px;"></ul>
</div>
<!-- Imported styles on this page -->
<link rel="stylesheet" href="assets/js/datatables/dataTables.bootstrap.css"/>
<link rel="stylesheet" href="assets/css/bootstrap-treeview.css">   
<script src="assets/js/bootstrap-treeview.min.js"></script>
<!-- Bottom Scripts -->
<script src="assets/js/bootstrap.min.js"></script>
<script src="assets/js/TweenMax.min.js"></script>
<script src="assets/js/resizeable.js"></script>
<script src="assets/js/joinable.js"></script>
<script src="assets/js/xenon-api.js"></script>
<script src="assets/js/xenon-toggles.js"></script>
<script src="assets/js/datatables/js/jquery.dataTables.min.js"></script>
<!-- Imported scripts on this page -->
<script src="assets/js/datatables/dataTables.bootstrap.js"></script>
<script src="assets/js/datatables/yadcf/jquery.dataTables.yadcf.js"></script>
<script src="assets/js/datatables/tabletools/dataTables.tableTools.min.js"></script>
<script src="assets/js/toastr/toastr.min.js"></script>
<!-- JavaScripts initializations and stuff -->
<script src="assets/js/xenon-custom.js"></script>
</body>
<script>

    function getAllSessionItems(){
        var session = {};
        for (var i = sessionStorage.length - 1; i >= 0; i--) {
            if (sessionStorage.key(i) != "userId" && sessionStorage.key(i) != "userToken" && sessionStorage.key(i) != "classification" && sessionStorage.key(i) != "_departId" && sessionStorage.key(i) != "userIp" && sessionStorage.key(i) != "loginName" && sessionStorage.key(i) != "_departdetail" && sessionStorage.key(i) != "_userName") {
                session[sessionStorage.key(i)] = sessionStorage.getItem(sessionStorage.key(i));
            }
        }
        return JSON.stringify(session);
    }
</script>
</html>
